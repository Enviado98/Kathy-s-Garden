<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Gossip Gang</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg: #e6e7ee;
            --purple: #6a1b9a;
            --black: #212121;
            --orange: #f57f17; /* Más saturado */
            --yellow: #fdd835;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none; /* Bloqueo de zoom/scroll */
            user-select: none;
            cursor: pointer;
            font-family: sans-serif;
        }

        /* ESCENARIO */
        .stage {
            position: relative;
            width: 320px;
            height: 300px;
            /* border: 1px solid red; debug */
        }

        /* --- CLASE MAESTRA DE PERSONAJE --- */
        .char-wrapper {
            position: absolute;
            bottom: 0;
            /* Importante: Overflow hidden recorta la cara cuando "giran" (se salen del cuerpo) */
            overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform-origin: bottom center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Contenedor de la cara (se mueve izq/der para simular giro de cabeza) */
        .face-group {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        .eyes-row {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: space-around; /* Distribución automática */
        }

        .eye {
            position: relative;
            background: white;
            border-radius: 50%;
            overflow: hidden;
        }

        .pupil {
            position: absolute;
            top: 30%; left: 30%;
            width: 40%; height: 40%;
            background: black;
            border-radius: 50%;
        }

        .eyelid {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 0%;
            background: inherit; /* Hereda color del cuerpo */
            z-index: 10;
        }
        /* Parche para color de párpados en Safari */
        .c-purple .eyelid { background: var(--purple); }
        .c-black .eyelid { background: var(--black); }
        .c-orange .eyelid { background: var(--orange); }
        .c-yellow .eyelid { background: var(--yellow); }

        .mouth {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            border-radius: 10px;
        }

        /* --- ESTILOS POR PERSONAJE (Segun Imagen) --- */

        /* 1. MORADO: Rectángulo alto, izquierda, perfil derecho */
        #purple {
            left: 20px; bottom: 80px;
            width: 100px; height: 210px;
            background: var(--purple);
            border-radius: 6px;
            z-index: 10;
        }
        #purple .eyes-row { top: 60px; padding: 0 15px; box-sizing: border-box; }
        #purple .eye { width: 18px; height: 18px; }
        #purple .mouth { top: 90px; width: 15px; height: 4px; }

        /* 2. NEGRO: Rectángulo medio, centro-atrás, de frente */
        #black {
            left: 130px; bottom: 70px;
            width: 80px; height: 160px;
            background: var(--black);
            border-radius: 6px;
            z-index: 5; /* Detrás */
        }
        #black .eyes-row { top: 50px; padding: 0 10px; box-sizing: border-box; }
        #black .eye { width: 14px; height: 14px; }
        #black .mouth { top: 75px; width: 10px; height: 2px; background: #666; }

        /* 3. AMARILLO: Curvo, derecha, perfil izquierdo */
        #yellow {
            right: 10px; bottom: 0;
            width: 90px; height: 140px;
            background: var(--yellow);
            border-radius: 50px 50px 0 0;
            z-index: 20;
        }
        #yellow .eyes-row { top: 40px; padding: 0 15px; box-sizing: border-box; }
        #yellow .eye { width: 10px; height: 10px; background: #000; } /* Ojos de punto */
        #yellow .pupil { display: none; } /* Sin pupila */
        #yellow .mouth { top: 60px; width: 25px; height: 3px; }

        /* 4. NARANJA (EL GORDITO): Semicírculo, abajo-izquierda, DE ESPALDAS */
        #orange {
            left: -10px; bottom: 0;
            width: 180px; /* Bien gordito */
            height: 120px;
            background: var(--orange);
            border-radius: 100px 100px 0 0;
            z-index: 30; /* En frente de todos */
        }
        #orange .eyes-row { top: 35px; justify-content: center; gap: 15px; }
        #orange .eye { width: 14px; height: 14px; }
        #orange .mouth { top: 60px; width: 20px; height: 5px; border-radius: 2px; }

    </style>
</head>
<body>

<div class="stage" id="stage">
    <!-- Los personajes se generan aquí -->
</div>

<script>
    // --- MOTOR DE IA & ANIMACIÓN ---

    // Configuración inicial de posición de la CARA (Face)
    // xOffset: Dónde está la cara al inicio (0 = centro, 100 = perfil derecho, -100 = perfil izq, 200 = espalda)
    const CHAR_CONFIG = [
        { id: 'purple', type: 'rect', startFaceX: 25, startMood: 'neutral' }, // Perfil mirando al centro
        { id: 'black', type: 'rect', startFaceX: 0, startMood: 'bored' },    // Mirando al gordito
        { id: 'yellow', type: 'round', startFaceX: -25, startMood: 'happy' }, // Perfil mirando al centro
        { id: 'orange', type: 'fat', startFaceX: 200, startMood: 'neutral' }  // ESPALDA TOTAL (Cara fuera del div)
    ];

    class Character {
        constructor(config, stage) {
            this.id = config.id;
            this.config = config;
            this.stage = stage;
            this.currentFaceX = config.startFaceX;
            this.isTalking = false;
            
            this.el = this.createDOM();
            this.face = this.el.querySelector('.face-group');
            this.eyes = this.el.querySelectorAll('.eye');
            this.pupils = this.el.querySelectorAll('.pupil');
            this.mouth = this.el.querySelector('.mouth');
            this.eyelids = this.el.querySelectorAll('.eyelid');

            // Posición inicial de la cara
            gsap.set(this.face, { x: this.currentFaceX });
            
            // Iniciar vida
            this.startBreathing();
            this.startBlinking();
            
            // Evento individual
            this.el.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                Director.handleCharTouch(this);
            });
        }

        createDOM() {
            const div = document.createElement('div');
            div.className = `char-wrapper c-${this.id}`;
            div.id = this.id;
            
            div.innerHTML = `
                <div class="face-group">
                    <div class="eyes-row">
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                    </div>
                    <div class="mouth"></div>
                </div>
            `;
            this.stage.appendChild(div);
            return div;
        }

        // --- SISTEMA DE MOVIMIENTO "FAKE 3D" ---
        
        // Mueve la cara entera (simula girar la cabeza)
        turnFaceTo(xVal, duration = 0.5, delay = 0) {
            this.currentFaceX = xVal;
            gsap.to(this.face, {
                x: xVal,
                duration: duration,
                delay: delay,
                ease: "power2.inOut"
            });
        }

        // Mueve solo las pupilas (simula mirar de reojo)
        moveEyes(x, y) {
            if (this.id === 'yellow') return; // El amarillo tiene ojos de punto, no mueve pupilas
            gsap.to(this.pupils, {
                x: x, y: y,
                duration: 0.3
            });
        }

        setExpression(type) {
            gsap.killTweensOf(this.eyelids);
            gsap.killTweensOf(this.mouth);

            if (type === 'angry') {
                gsap.to(this.eyelids, { height: '50%', duration: 0.2 });
                gsap.to(this.mouth, { width: 10, borderRadius: 0, height: 2, duration: 0.2 });
            } else if (type === 'shock') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.1 });
                gsap.to(this.mouth, { width: 10, borderRadius: '50%', height: 10, duration: 0.1 });
            } else if (type === 'suspicious') {
                gsap.to(this.eyelids, { height: '35%', duration: 0.4 });
                gsap.to(this.mouth, { width: 8, x: 5, duration: 0.4 }); // Boca torcida
            } else {
                // Neutral
                gsap.to(this.eyelids, { height: '0%', duration: 0.5 });
                const w = this.id === 'yellow' ? 25 : 15;
                gsap.to(this.mouth, { width: w, borderRadius: '10px', height: 3, x: 0, duration: 0.5 });
            }
        }

        talk() {
            if(this.isTalking) return;
            this.isTalking = true;

            // Si el gordito está de espaldas (x > 100), no vemos su boca, pero su cuerpo rebota
            const isBackTurned = this.currentFaceX > 80;

            if (!isBackTurned) {
                // Animación de boca
                this.talkAnim = gsap.to(this.mouth, {
                    scaleY: 2, width: "+=2",
                    duration: 0.15, repeat: -1, yoyo: true
                });
            }
            
            // Animación de cuerpo (siempre ocurre)
            this.bodyAnim = gsap.to(this.el, {
                scaleY: 1.02,
                y: -2,
                duration: 0.2, repeat: -1, yoyo: true
            });
        }

        stopTalking() {
            this.isTalking = false;
            if(this.talkAnim) this.talkAnim.kill();
            if(this.bodyAnim) this.bodyAnim.kill();
            gsap.to(this.mouth, { scaleY: 1, duration: 0.2 });
            gsap.to(this.el, { scaleY: 1, y: 0, duration: 0.2 });
        }

        // --- VIDA ORGÁNICA ---
        startBreathing() {
            // Cada uno respira a su ritmo
            const speed = Math.random() * 1 + 2;
            gsap.to(this.el, {
                scaleY: 1.01,
                transformOrigin: 'bottom center',
                duration: speed,
                repeat: -1, yoyo: true, ease: "sine.inOut"
            });
        }

        startBlinking() {
            const loop = () => {
                const delay = Math.random() * 3000 + 2000;
                gsap.to(this.eyelids, { height: '100%', duration: 0.1, yoyo: true, repeat: 1 });
                setTimeout(loop, delay);
            };
            setTimeout(loop, Math.random() * 2000);
        }
    }

    // --- DIRECTOR DE ESCENA (IA) ---
    const Director = {
        chars: {},
        state: 'GOSSIP', // GOSSIP, SUSPICIOUS, ANGRY
        patience: 3, // Intentos antes de enojarse
        timer: null,

        init() {
            const stage = document.getElementById('stage');
            CHAR_CONFIG.forEach(c => {
                this.chars[c.id] = new Character(c, stage);
            });
            
            this.startGossipLoop();

            // Click Global (Fondo)
            document.body.addEventListener('pointerdown', (e) => {
                if(!e.target.closest('.char-wrapper')) {
                    this.handleDisturbance();
                }
            });
        },

        // --- MODO CHISME ---
        startGossipLoop() {
            const loop = () => {
                if(this.state !== 'GOSSIP') return;

                // Resetear
                Object.values(this.chars).forEach(c => c.stopTalking());

                // Alguien habla
                const ids = Object.keys(this.chars);
                const speakerId = ids[Math.floor(Math.random() * ids.length)];
                const speaker = this.chars[speakerId];
                
                speaker.talk();

                // Reacciones sutiles
                Object.values(this.chars).forEach(c => {
                    if(c !== speaker) {
                        // Si es el gordito y está de espalda, a veces mira de reojo para escuchar mejor
                        if(c.id === 'orange' && Math.random() > 0.7) {
                             // Desliza la cara un poco hacia adentro (pero sigue de espalda)
                             c.turnFaceTo(120, 1); 
                        }
                    }
                });

                this.timer = setTimeout(loop, Math.random() * 2000 + 1000);
            };
            loop();
        },

        // --- REACCIÓN AL USUARIO (Disturbance) ---
        handleDisturbance() {
            this.patience--;
            clearTimeout(this.timer);
            Object.values(this.chars).forEach(c => c.stopTalking());

            console.log("Paciencia:", this.patience);

            if (this.patience === 2) {
                // NIVEL 1: "ALGUIEN ESCUCHA" (SOSPECHA LEVE)
                this.state = 'SUSPICIOUS';
                
                // 1. Gordito (Naranja) mira sobre el hombro
                // Su cara está en x:200 (fuera), la traemos a x:60 (borde visible)
                const fat = this.chars['orange'];
                fat.turnFaceTo(70, 0.8, 0); // Lento
                fat.moveEyes(4, 0); // Mira a la esquina
                fat.setExpression('suspicious');

                // 2. Líder (Morado) deja de hablar y mira de reojo (solo pupilas)
                const leader = this.chars['purple'];
                leader.moveEyes(4, 0); 
                leader.setExpression('suspicious');
                
                // Vuelven a la normalidad si no haces nada más
                setTimeout(() => this.recover(), 3000);

            } else if (this.patience <= 0) {
                // NIVEL 2: "QUÉ QUIERES" (ENOJO TOTAL)
                this.state = 'ANGRY';
                
                // Coreografía de giro dramático asíncrono
                
                // El Gordito se da la vuelta COMPLETA (Lento y pesado)
                const fat = this.chars['orange'];
                fat.turnFaceTo(0, 1.5, 0.2); // x:0 es centro total
                fat.setExpression('angry');
                
                // El Morado se encara
                const purple = this.chars['purple'];
                purple.turnFaceTo(0, 0.6, 0); // Rápido
                purple.setExpression('angry');

                // El Amarillo se asoma tímido pero molesto
                const yellow = this.chars['yellow'];
                yellow.turnFaceTo(0, 0.8, 0.4); 
                yellow.setExpression('neutral'); // El amarillo no suele enojarse, solo observa

                // El Negro suspira (aburrido)
                const black = this.chars['black'];
                black.setExpression('bored');
                
                // Recuperación lenta
                setTimeout(() => {
                    this.patience = 3;
                    this.recover();
                }, 5000);
            }
        },

        handleCharTouch(char) {
            // Interacción Individual (Rompe todo)
            this.patience = 0; // Trigger inmediato de enojo grupal después
            
            // Reacción física inmediata
            gsap.to(char.el, { scale: 1.1, duration: 0.1, yoyo: true, repeat: 1 });

            if (char.id === 'orange') {
                // Si tocas al gordito de espaldas, se gira asustado rápido
                char.turnFaceTo(0, 0.3);
                char.setExpression('shock');
                setTimeout(() => char.turnFaceTo(200, 1), 2000); // Vuelve a esconderse
            } else if (char.id === 'purple') {
                // El lider se ofende
                char.turnFaceTo(0, 0.3);
                char.setExpression('angry');
            }

            // Los demás miran al tocado
            Object.values(this.chars).forEach(c => {
                if(c !== char) {
                    c.turnFaceTo(0, 0.5, Math.random()*0.3); // Miran al centro
                    c.moveEyes(char.id === 'orange' ? -3 : 3, 0); // Miran hacia el lado
                }
            });

            setTimeout(() => this.recover(), 3500);
        },

        recover() {
            this.state = 'GOSSIP';
            this.patience = 3;

            // Todos vuelven a su posición original (Config)
            Object.values(this.chars).forEach(c => {
                // Delay aleatorio para que no parezcan robots
                const delay = Math.random() * 0.5;
                c.turnFaceTo(c.config.startFaceX, 1.2, delay);
                c.setExpression(c.config.startMood);
                c.moveEyes(0, 0);
            });

            setTimeout(() => this.startGossipLoop(), 1500);
        }
    };

    window.onload = () => Director.init();

</script>
</body>
</html>
