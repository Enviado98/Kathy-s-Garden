<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Gossips AI</title>
    <!-- Importamos GSAP para animaciones de física profesional -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg: #e0e0e8;
            --purple: #6a00ff;
            --black: #1f1f1f;
            --yellow: #ffcf00;
            --orange: #ff6b35;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg);
            overflow: hidden; /* No scroll */
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        /* Escenario con perspectiva para simular el círculo */
        .stage {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            perspective: 800px; /* Clave para el efecto 3D */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 50px;
        }

        /* --- BASE DEL PERSONAJE --- */
        .char-wrapper {
            position: absolute;
            bottom: 0;
            transform-style: preserve-3d;
            transform-origin: bottom center;
            /* Se posicionarán por JS */
        }

        .char-body {
            position: relative;
            transform-origin: bottom center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: background 0.3s;
        }

        /* --- CARA (Ojos y Boca) --- */
        .face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .eyes-container {
            position: absolute;
            display: flex;
            justify-content: space-between;
            /* La posición varía por personaje */
        }

        .eye {
            position: relative;
            background: #fff;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pupil {
            position: absolute;
            background: #000;
            border-radius: 50%;
            width: 40%;
            height: 40%;
        }

        /* Párpados para expresiones (Enojo, Aburrimiento, Parpadeo) */
        .eyelid {
            position: absolute;
            width: 100%;
            height: 0%; /* 0% abierto, 50% mitad, 100% cerrado */
            background: inherit; /* Toma el color del cuerpo */
            z-index: 10;
            transition: height 0.1s;
        }
        .eyelid.top { top: 0; }
        .eyelid.bottom { bottom: 0; }

        .mouth {
            position: absolute;
            background: #000;
            border-radius: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 2px;
        }

        /* --- DISEÑOS ESPECÍFICOS --- */

        /* 1. MORADO (Líder) */
        .char-purple .char-body {
            width: 120px;
            height: 240px;
            background: var(--purple);
            border-radius: 12px;
        }
        .char-purple .eyes-container { top: 70px; width: 60px; left: 30px; }
        .char-purple .eye { width: 22px; height: 22px; }
        .char-purple .mouth { top: 110px; width: 20px; height: 4px; }

        /* 2. NEGRO (Aburrido/Cínico) */
        .char-black .char-body {
            width: 90px;
            height: 180px;
            background: var(--black);
            border-radius: 8px;
        }
        .char-black .eyes-container { top: 60px; width: 50px; left: 20px; }
        .char-black .eye { width: 18px; height: 18px; background: #fff; }
        .char-black .mouth { top: 95px; width: 15px; height: 2px; background: #555; }

        /* 3. AMARILLO (Tímido) */
        .char-yellow .char-body {
            width: 100px;
            height: 140px;
            background: var(--yellow);
            border-radius: 50px 50px 0 0; /* Forma de dedo */
        }
        .char-yellow .eyes-container { top: 45px; width: 40px; left: 30px; }
        .char-yellow .eye { width: 12px; height: 12px; }
        .char-yellow .mouth { top: 70px; width: 10px; height: 3px; }

        /* 4. NARANJA (Tonto/Feliz) */
        .char-orange .char-body {
            width: 160px;
            height: 100px;
            background: var(--orange);
            border-radius: 80px 80px 0 0; /* Semicírculo */
        }
        .char-orange .eyes-container { top: 35px; width: 60px; left: 50px; }
        .char-orange .eye { width: 14px; height: 14px; }
        .char-orange .mouth { top: 65px; width: 20px; height: 8px; border-radius: 0 0 20px 20px; }

        /* --- CLASES DE ESTADO EXTRA --- */
        .sweat-drop {
            position: absolute;
            top: -20px;
            right: 0;
            width: 10px;
            height: 15px;
            background: #00d2ff;
            border-radius: 0 50% 50% 50%;
            transform: rotate(45deg);
            opacity: 0;
        }

    </style>
</head>
<body>

<div class="stage" id="stage">
    <!-- Los personajes se inyectan aquí vía JS para tener control total del DOM -->
</div>

<script>
    /**
     * CLASE CHARACTER
     * Controla la física, expresiones y renderizado de cada bicho individualmente.
     */
    class Character {
        constructor(config, stage) {
            this.id = config.id;
            this.color = config.color;
            this.type = config.type; // 'rect', 'round', etc
            this.xPos = config.x;
            this.zPos = config.z;
            this.scale = config.scale;
            this.rotationBase = config.rotation;
            
            this.stage = stage;
            this.isTalking = false;
            this.blinkTimer = null;
            
            this.element = this.createDOM();
            this.body = this.element.querySelector('.char-body');
            this.mouth = this.element.querySelector('.mouth');
            this.pupils = this.element.querySelectorAll('.pupil');
            this.eyelids = this.element.querySelectorAll('.eyelid.top'); // Solo usamos párpado superior para simplificar expresión
            
            // Iniciar ciclo de vida autónomo
            this.startBreathing();
            this.startBlinking();
            this.setMood('neutral');
        }

        createDOM() {
            const wrapper = document.createElement('div');
            wrapper.className = `char-wrapper char-${this.id}`;
            // Posicionamiento 3D inicial
            wrapper.style.left = `calc(50% + ${this.xPos}px)`;
            wrapper.style.zIndex = Math.floor(this.zPos + 100);
            
            // Usamos GSAP para setear propiedades iniciales limpiamente
            gsap.set(wrapper, {
                z: this.zPos,
                scale: this.scale,
                xPercent: -50 // Centrar
            });

            wrapper.innerHTML = `
                <div class="char-body">
                    <div class="sweat-drop"></div>
                    <div class="face">
                        <div class="eyes-container">
                            <div class="eye">
                                <div class="pupil"></div>
                                <div class="eyelid top"></div>
                            </div>
                            <div class="eye">
                                <div class="pupil"></div>
                                <div class="eyelid top"></div>
                            </div>
                        </div>
                        <div class="mouth"></div>
                    </div>
                </div>
            `;
            this.stage.appendChild(wrapper);
            return wrapper;
        }

        // --- MICRO-MOVIMIENTOS (Vida) ---

        startBreathing() {
            // Respiración asíncrona (scaleY y scaleX inversos)
            const duration = 2 + Math.random();
            gsap.to(this.body, {
                scaleY: 1.02,
                scaleX: 0.99,
                y: -2,
                duration: duration,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut",
                delay: Math.random() // Desfase para que no respiren al unísono
            });
        }

        startBlinking() {
            const blink = () => {
                if (this.mood === 'angry') return; // No parpadear si está furioso (mirada fija)
                
                const tl = gsap.timeline({
                    onComplete: () => {
                        this.blinkTimer = setTimeout(blink, Math.random() * 3000 + 2000);
                    }
                });
                
                // Cierra ojos
                tl.to(this.eyelids, { height: '100%', duration: 0.1, ease: 'power1.in' })
                  .to(this.eyelids, { height: '0%', duration: 0.15, ease: 'power1.out' });
            };
            this.blinkTimer = setTimeout(blink, Math.random() * 3000);
        }

        // --- EXPRESIONES ---

        setMood(mood) {
            this.mood = mood;
            const topLids = this.element.querySelectorAll('.eyelid.top');
            
            // Matamos animaciones previas de párpados
            gsap.killTweensOf(topLids);

            if (mood === 'angry') {
                // Ceño fruncido: Párpados a la mitad
                gsap.to(topLids, { height: '45%', backgroundColor: this.getBodyColor(), duration: 0.4 });
                gsap.to(this.mouth, { width: 10, height: 2, borderRadius: 0, duration: 0.3 }); // Boca línea recta
            } else if (mood === 'bored') {
                gsap.to(topLids, { height: '30%', duration: 0.5 });
                gsap.to(this.mouth, { width: 8, height: 2, duration: 0.5 });
            } else if (mood === 'surprise') {
                gsap.to(topLids, { height: '0%', duration: 0.2 });
                gsap.to(this.mouth, { width: 10, height: 10, borderRadius: '50%', duration: 0.2 });
            } else {
                // Neutral / Happy
                gsap.to(topLids, { height: '0%', duration: 0.4 });
                gsap.to(this.mouth, { width: 15, borderRadius: '0 0 10px 10px', duration: 0.4 });
            }
        }

        getBodyColor() {
            // Helper para obtener color computado para el párpado
            return window.getComputedStyle(this.body).backgroundColor;
        }

        // --- ACCIONES ---

        lookAt(targetX, targetY) {
            // Lógica para mover pupilas
            const eyes = this.element.querySelector('.eyes-container');
            const rect = eyes.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const angle = Math.atan2(targetY - centerY, targetX - centerX);
            const dist = Math.min(6, Math.hypot(targetX - centerX, targetY - centerY) / 20); // Limitar distancia

            const pupilX = Math.cos(angle) * dist;
            const pupilY = Math.sin(angle) * dist;

            gsap.to(this.pupils, {
                x: pupilX,
                y: pupilY,
                duration: 0.3,
                ease: "power2.out"
            });
        }

        turnTo(angle) {
            // Gira el cuerpo entero (simulando 3D)
            gsap.to(this.element, {
                rotationY: angle,
                duration: 0.8,
                ease: "back.out(1.2)"
            });
        }

        talk() {
            if (this.isTalking) return;
            this.isTalking = true;
            
            // Animación de boca hablando (lip sync fake)
            this.talkTween = gsap.to(this.mouth, {
                height: () => Math.random() * 10 + 2, // Altura aleatoria
                width: () => Math.random() * 5 + 10,
                duration: 0.15,
                repeat: -1,
                yoyo: true,
                ease: "power1.inOut"
            });

            // Pequeño movimiento corporal al hablar
            this.bodyTalkTween = gsap.to(this.body, {
                rotation: () => (Math.random() - 0.5) * 5,
                duration: 0.2,
                repeat: -1,
                yoyo: true
            });
        }

        stopTalking() {
            this.isTalking = false;
            if (this.talkTween) {
                this.talkTween.kill();
                this.bodyTalkTween.kill();
                gsap.to(this.mouth, { height: 2, width: 10, duration: 0.2 });
                gsap.to(this.body, { rotation: 0, duration: 0.4 });
            }
        }

        jump() {
            gsap.to(this.body, { y: -30, duration: 0.15, yoyo: true, repeat: 1, ease: "power2.out" });
        }
        
        shiver() {
            gsap.to(this.body, { x: 2, duration: 0.05, yoyo: true, repeat: 10 });
        }
    }

    /**
     * DIRECTOR (AI BRAIN)
     * Orquesta la escena, decide quién habla y maneja la interacción global.
     */
    class Director {
        constructor() {
            const stage = document.getElementById('stage');
            
            // Inicializar personajes con posiciones estratégicas (Arco)
            this.chars = {
                purple: new Character({ id: 'purple', color: '#6a00ff', x: -120, z: -50, scale: 0.95, rotation: 15 }, stage),
                black: new Character({ id: 'black', color: '#1f1f1f', x: -40, z: -80, scale: 0.9, rotation: 5 }, stage),
                orange: new Character({ id: 'orange', color: '#ff6b35', x: 50, z: 0, scale: 1, rotation: -10 }, stage),
                yellow: new Character({ id: 'yellow', color: '#ffcf00', x: 130, z: -40, scale: 0.92, rotation: -20 }, stage)
            };

            this.charArray = Object.values(this.chars);
            this.state = 'IDLE'; // IDLE, GOSSIP, JUDGING
            this.timer = null;
            this.mousePos = { x: window.innerWidth/2, y: window.innerHeight/2 };

            this.initEvents();
            this.startLoop();
        }

        initEvents() {
            // Movimiento del mouse (ojos siguen si no están ocupados)
            window.addEventListener('mousemove', (e) => {
                this.mousePos = { x: e.clientX, y: e.clientY };
                if (this.state === 'JUDGING') {
                    this.charArray.forEach(c => c.lookAt(this.mousePos.x, this.mousePos.y));
                }
            });

            // INTERACCIÓN PRINCIPAL: TOQUE DE PANTALLA
            const handleTouch = (e) => {
                // Si ya están juzgando, no hacemos nada o reiniciamos el juicio
                if (this.state === 'JUDGING') return;

                this.interruptAndJudge();
            };

            window.addEventListener('mousedown', handleTouch);
            window.addEventListener('touchstart', handleTouch, {passive: false});
        }

        // Loop de decisiones de la "IA"
        startLoop() {
            const think = () => {
                if (this.state === 'JUDGING') {
                    // Si están enojados, no hacen nada, solo esperan a que se calme la cosa
                    return; 
                }

                // Elegir acción aleatoria basada en probabilidades
                const rand = Math.random();

                if (rand < 0.6) {
                    this.startGossip(); // 60% probabilidad de chisme
                } else if (rand < 0.8) {
                    this.idleMoment(); // 20% momento de silencio/miradas
                } else {
                    this.randomEvent(); // 20% evento raro (susto, idea, chequeo de usuario)
                }

                // Programar siguiente pensamiento (tiempo variable para naturalidad)
                const nextTime = Math.random() * 3000 + 2000; 
                this.timer = setTimeout(think, nextTime);
            };

            think();
        }

        // --- COMPORTAMIENTOS ---

        startGossip() {
            this.state = 'GOSSIP';
            this.resetAll();

            // Elegir quién habla
            const speaker = this.getRandomChar();
            // Elegir quiénes escuchan (el resto)
            const listeners = this.charArray.filter(c => c !== speaker);

            // Acción: El que habla
            speaker.turnTo(0); // Mira al grupo (centro aprox)
            speaker.talk();
            speaker.setMood('neutral');

            // Acción: Los que escuchan
            listeners.forEach(c => {
                // Calcular ángulo para mirar al que habla
                // Simplificación: Girar hacia la posición X del hablante
                const angle = (speaker.xPos - c.xPos) > 0 ? 25 : -25;
                c.turnTo(angle);
                
                // Ojos miran al DOM element del hablante
                const speakerRect = speaker.element.getBoundingClientRect();
                c.lookAt(speakerRect.left + speakerRect.width/2, speakerRect.top + 50);

                // Reacciones aleatorias de los oyentes
                const reaction = Math.random();
                if (reaction > 0.7) c.setMood('surprise');
                else if (reaction < 0.2 && c.id === 'black') c.setMood('bored'); // El negro se aburre fácil
                else c.setMood('neutral');
            });
        }

        idleMoment() {
            this.state = 'IDLE';
            this.resetAll();
            
            // Todos miran a puntos aleatorios o suspiran
            this.charArray.forEach(c => {
                c.stopTalking();
                c.turnTo(0); // Vuelven a mirar al frente (vago)
                c.lookAt(
                    window.innerWidth/2 + (Math.random()-0.5)*200, 
                    window.innerHeight/2 + (Math.random()-0.5)*200
                );
                c.setMood('neutral');
            });
        }

        randomEvent() {
            const eventType = Math.floor(Math.random() * 3);
            
            if (eventType === 0) {
                // "Cuarta pared": Uno mira sospechosamente a la cámara
                const suspicious = this.getRandomChar();
                suspicious.lookAt(window.innerWidth/2, window.innerHeight*2); // Mirar al usuario
                suspicious.setMood('bored');
            } else if (eventType === 1) {
                // "Idea": El morado salta
                this.chars.purple.jump();
                this.chars.purple.setMood('surprise');
            } else {
                // "Susto": El amarillo tiembla
                this.chars.yellow.shiver();
                this.chars.yellow.setMood('surprise');
            }
        }

        // --- LA LÓGICA DE INTERRUPCIÓN (PEDIDO PRINCIPAL) ---

        interruptAndJudge() {
            console.log("INTERRUPCIÓN DETECTADA");
            clearTimeout(this.timer); // Detener cerebro
            this.state = 'JUDGING';
            
            // Detener cualquier charla
            this.charArray.forEach(c => c.stopTalking());

            // SECUENCIA CINEMÁTICA DE ENOJO
            // 1. Congelar un instante (shock)
            // 2. Girar lentamente hacia el usuario
            // 3. Poner cara de enojo
            
            this.charArray.forEach((c, index) => {
                // Retraso escalonado muy leve para realismo
                const delay = index * 0.05; 

                // GSAP Timeline para la reacción
                const tl = gsap.timeline();

                // Paso 1: Girar al frente (0 grados) lentamente
                tl.to(c.element, { 
                    rotationY: 0, 
                    duration: 1.5, 
                    ease: "power2.inOut",
                    delay: delay
                }, 0);

                // Paso 2: Escalar un poco (intimidación)
                tl.to(c.body, {
                    scale: 1.05,
                    duration: 1,
                    ease: "back.out(1.7)"
                }, 0.5);

                // Paso 3: Ojos clavar mirada en el centro (usuario)
                tl.add(() => {
                    c.lookAt(window.innerWidth/2, window.innerHeight/2);
                    c.setMood('angry'); // Párpados bajan
                }, 0.8);
            });

            // Volver a la normalidad después de unos segundos incómodos
            setTimeout(() => {
                this.recoverFromJudgment();
            }, 4000); // 4 segundos de juicio silencioso
        }

        recoverFromJudgment() {
            // Se relajan
            this.charArray.forEach(c => {
                gsap.to(c.body, { scale: 1, duration: 0.5 });
                c.setMood('neutral');
            });
            
            this.state = 'IDLE';
            // Uno hace un comentario final (chisme) y reinicia
            setTimeout(() => {
                this.startLoop();
            }, 1000);
        }

        // Helpers
        getRandomChar() {
            return this.charArray[Math.floor(Math.random() * this.charArray.length)];
        }
        
        resetAll() {
            this.charArray.forEach(c => c.stopTalking());
        }
    }

    // INICIAR TODO AL CARGAR
    window.onload = () => {
        const app = new Director();
    };

</script>
</body>
</html>
