<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathy's Garden | 3D Realm</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        
        /* Capa de Texto (UI) */
        #ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none; /* Click traspasa al 3D */
            z-index: 10;
            font-family: 'Courier New', Courier, monospace; /* Fallback */
        }
        
        /* Importamos fuentes bonitas */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Quicksand:wght@300&display=swap');

        h1 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 5rem;
            color: #fff;
            margin: 0;
            text-shadow: 0 0 30px rgba(255, 0, 200, 0.8), 0 0 60px rgba(0, 200, 255, 0.6);
            letter-spacing: 5px;
            animation: pulse 4s infinite ease-in-out;
        }

        p {
            font-family: 'Quicksand', sans-serif;
            color: #aaddff;
            font-size: 1.2rem;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /* Pequeña animación del texto */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }

        /* Cargando... */
        #loader {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: white;
            font-family: sans-serif;
            font-size: 0.8rem;
            opacity: 0.5;
        }
    </style>
    
    <!-- Mapa de importación para que el navegador sepa dónde buscar Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui">
        <h1>Kathy's Garden</h1>
        <p>A Digital Sanctuary</p>
    </div>
    <div id="loader">Generando ecosistema 3D...</div>

    <!-- El script principal del 3D -->
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // 1. ESCENA Y CÁMARA
        const scene = new THREE.Scene();
        // Niebla densa para ocultar el horizonte y dar atmósfera mística
        scene.fog = new THREE.FogExp2(0x050510, 0.035); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.5, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: false }); // Bloom se encarga del suavizado
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        // 2. POST-PROCESADO (EL EFECTO GLOW/BLOOM)
        const renderScene = new RenderPass(scene, camera);
        
        // Configuración del Brillo (Bloom)
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0;   // Qué tan brillante debe ser algo para brillar (0 = todo brilla un poco)
        bloomPass.strength = 2.0;  // Intensidad del brillo (Muy alto para efecto mágico)
        bloomPass.radius = 0.5;    // Radio de dispersión

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // 3. CREACIÓN DEL MUNDO (PROCEDURAL)
        
        // Materiales
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x111111, 
            roughness: 0.4, 
            metalness: 0.6 
        });

        // Suelo (Plano infinito simulado)
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200, 64, 64), groundMaterial);
        plane.rotation.x = -Math.PI / 2;
        // Creamos montañas suaves moviendo vértices
        const posAttribute = plane.geometry.attributes.position;
        for ( let i = 0; i < posAttribute.count; i ++ ) {
            const z = posAttribute.getZ( i );
            // Ruido aleatorio para el terreno
            posAttribute.setZ( i, z + Math.random() * 1.5 ); 
        }
        scene.add(plane);

        // Generador de Árboles abstractos (Cristales)
        const treeGeometry = new THREE.ConeGeometry(0.2, 1, 4, 1);
        const treeMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff }); // Cian base
        const treeCount = 400;

        const instancedTrees = new THREE.InstancedMesh(treeGeometry, treeMaterial, treeCount);
        const dummy = new THREE.Object3D();
        const colors = [];

        for(let i=0; i<treeCount; i++) {
            // Posición aleatoria
            const x = (Math.random() - 0.5) * 60;
            const z = (Math.random() - 0.5) * 60 - 10; // Más hacia atrás
            
            // Escalado aleatorio (altos y delgados)
            const s = Math.random() * 0.5 + 0.5; 
            const h = Math.random() * 5 + 2;
            
            dummy.position.set(x, h/2 - 0.5, z);
            dummy.scale.set(s, h, s);
            dummy.rotation.y = Math.random() * Math.PI;
            dummy.updateMatrix();
            instancedTrees.setMatrixAt(i, dummy.matrix);

            // Colores Neon aleatorios por árbol
            const color = new THREE.Color();
            // Mezcla entre azul, morado y magenta
            color.setHSL(Math.random() * 0.2 + 0.5, 0.9, 0.5); 
            instancedTrees.setColorAt(i, color);
        }
        scene.add(instancedTrees);

        // 4. LUCIÉRNAGAS (SISTEMA DE PARTÍCULAS)
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 1500;
        const posArray = new Float32Array(particlesCount * 3);
        const randomArray = new Float32Array(particlesCount); // Para animaciones individuales

        for(let i = 0; i < particlesCount * 3; i+=3) {
            posArray[i] = (Math.random() - 0.5) * 50;     // X
            posArray[i+1] = Math.random() * 10;           // Y (Altura)
            posArray[i+2] = (Math.random() - 0.5) * 50 - 5; // Z
            
            randomArray[i/3] = Math.random(); // Fase aleatoria
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeometry.setAttribute('aRandom', new THREE.BufferAttribute(randomArray, 1));

        // Material de partículas personalizado
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.08,
            color: 0xffffee, // Blanco dorado
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        const fireflies = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(fireflies);

        // 5. ILUMINACIÓN
        const ambientLight = new THREE.AmbientLight(0x404040, 2); // Luz base tenue
        scene.add(ambientLight);

        // Luces puntuales de colores (Magia)
        const light1 = new THREE.PointLight(0xff00ff, 2, 20); // Magenta
        light1.position.set(5, 5, 5);
        scene.add(light1);

        const light2 = new THREE.PointLight(0x00ffff, 2, 20); // Cian
        light2.position.set(-5, 5, -5);
        scene.add(light2);


        // 6. ANIMACIÓN E INTERACCIÓN
        let mouseX = 0;
        let mouseY = 0;
        let targetX = 0;
        let targetY = 0;

        const windowHalfX = window.innerWidth / 2;
        const windowHalfY = window.innerHeight / 2;

        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX - windowHalfX) * 0.001;
            mouseY = (event.clientY - windowHalfY) * 0.001;
        });

        const clock = new THREE.Clock();

        function animate() {
            const time = clock.getElapsedTime();

            // Movimiento suave de cámara
            targetX = mouseX * 2;
            targetY = mouseY * 2;
            
            camera.position.x += (targetX - camera.position.x) * 0.05;
            camera.position.y += (-targetY - camera.position.y + 2) * 0.05; // +2 base height
            camera.lookAt(0, 1, 0);

            // Animar Luciérnagas (Ondulación vertical y horizontal)
            const positions = fireflies.geometry.attributes.position.array;
            for(let i=0; i<particlesCount; i++) {
                const i3 = i*3;
                // Movimiento orgánico basado en tiempo y posición original
                positions[i3 + 1] += Math.sin(time * 0.5 + positions[i3]) * 0.005; // Y
                positions[i3] += Math.cos(time * 0.3 + positions[i3+1]) * 0.005;   // X
            }
            fireflies.geometry.attributes.position.needsUpdate = true;

            // Rotación leve del bosque
            instancedTrees.rotation.y = Math.sin(time * 0.05) * 0.05;

            // Renderizar con el efecto Bloom
            composer.render();
            requestAnimationFrame(animate);
        }

        // Ajuste de ventana
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('loader').style.display = 'none';
        animate();
    </script>
</body>
</html>
