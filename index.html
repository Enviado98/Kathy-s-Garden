<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gossip Gang v1.1: Paranoia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg: #e8e8f2;
            --purple: #6a1b9a;
            --black: #212121;
            --orange: #ff6f00;
            --yellow: #fdd835;
        }

        /* --- CORE SETUP --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            touch-action: none;
        }

        .stage {
            position: relative;
            width: 340px;
            height: 320px;
            pointer-events: none;
        }

        /* --- PERSONAJES --- */
        .char-wrapper {
            position: absolute;
            bottom: 0;
            pointer-events: auto;
            overflow: hidden;
            transform-origin: bottom center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: z-index 0s; 
            will-change: transform;
        }

        .face-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        .eyes-row {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }

        .eye {
            position: relative;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .pupil {
            position: absolute;
            background: black;
            border-radius: 50%;
            width: 45%; height: 45%;
            top: 27%; left: 27%;
        }

        .eyelid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 0%;
            background: inherit; 
            z-index: 10;
        }
        
        /* Fix colores párpados */
        .c-purple .eyelid { background: var(--purple); }
        .c-black .eyelid { background: var(--black); }
        .c-orange .eyelid { background: var(--orange); }
        .c-yellow .eyelid { background: var(--yellow); }

        .mouth {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            border-radius: 10px;
        }

        /* --- ESTILOS INDIVIDUALES --- */
        #purple {
            left: 30px; bottom: 90px;
            width: 90px; height: 200px;
            background: var(--purple);
            border-radius: 8px;
            z-index: 10;
        }
        #purple .eyes-row { top: 60px; padding: 0 10px; }
        #purple .eye { width: 20px; height: 20px; }
        #purple .mouth { top: 95px; width: 20px; height: 4px; }

        #black {
            left: 140px; bottom: 80px;
            width: 80px; height: 160px;
            background: var(--black);
            border-radius: 6px;
            z-index: 5;
        }
        #black .eyes-row { top: 50px; padding: 0 8px; }
        #black .eye { width: 16px; height: 16px; }
        #black .mouth { top: 80px; width: 12px; height: 2px; background: #666; }

        #yellow {
            right: 20px; bottom: 0;
            width: 80px; height: 130px;
            background: var(--yellow);
            border-radius: 40px 40px 0 0;
            z-index: 20;
        }
        #yellow .eyes-row { top: 40px; padding: 0 10px; }
        #yellow .eye { width: 12px; height: 12px; background: #111; }
        #yellow .pupil { display: none; }
        #yellow .mouth { top: 65px; width: 15px; height: 3px; }

        #orange {
            left: -10px; bottom: 0;
            width: 190px; height: 110px;
            background: var(--orange);
            border-radius: 95px 95px 10px 10px;
            z-index: 30;
        }
        #orange .eyes-row { top: 35px; justify-content: center; gap: 20px; }
        #orange .eye { width: 15px; height: 15px; }
        #orange .mouth { top: 65px; width: 25px; height: 5px; }

        /* PARTICULAS */
        .spit {
            position: fixed; width: 12px; height: 12px;
            background: #a0e0ff; border-radius: 50%;
            border: 2px solid #fff; pointer-events: none; z-index: 9999;
        }
        .sweat {
            position: absolute; width: 8px; height: 12px;
            background: #00d2ff; border-radius: 0 50% 50% 50%;
            transform: rotate(45deg);
        }

    </style>
</head>
<body>

<div class="stage" id="stage"></div>

<script>
    /**
     * CONFIGURACIÓN DE PERSONAJES
     * leanDir: Dirección de inclinación para cuchichear (-1 izq, 1 der)
     */
    const CHARS_CONFIG = [
        { id: 'purple', type: 'rect', faceX: 30,  leanDir: 5 },
        { id: 'black',  type: 'rect', faceX: 0,   leanDir: 2 },
        { id: 'yellow', type: 'round', faceX: -20, leanDir: -5 },
        { id: 'orange', type: 'fat',   faceX: 200, leanDir: 2 } 
    ];

    class Character {
        constructor(config, stage) {
            this.id = config.id;
            this.config = config;
            this.currentFaceX = config.faceX;
            this.isTalking = false;

            this.el = this.createDOM(stage);
            this.face = this.el.querySelector('.face-layer');
            this.pupils = this.el.querySelectorAll('.pupil');
            this.eyelids = this.el.querySelectorAll('.eyelid');
            this.mouth = this.el.querySelector('.mouth');

            gsap.set(this.face, { x: this.currentFaceX });
            
            this.breathe();
            this.blink();

            this.el.addEventListener('pointerdown', (e) => {
                e.stopPropagation(); e.preventDefault();
                Director.handleCharTouch(this);
            });
        }

        createDOM(stage) {
            const div = document.createElement('div');
            div.className = `char-wrapper c-${this.id}`;
            div.id = this.id;
            div.innerHTML = `
                <div class="face-layer">
                    <div class="eyes-row">
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                    </div>
                    <div class="mouth"></div>
                </div>
            `;
            stage.appendChild(div);
            return div;
        }

        // --- MOVIMIENTO ---
        turnTo(targetX, speed = 1, delay = 0) {
            this.currentFaceX = targetX;
            gsap.to(this.face, { x: targetX, duration: speed, delay: delay, ease: "power2.inOut" });
        }

        look(x, y, speed = 0.3) {
            if(this.id !== 'yellow') gsap.to(this.pupils, { x: x, y: y, duration: speed });
        }

        lean(angle, duration = 0.5) {
            gsap.to(this.el, { rotation: angle, duration: duration, ease: "back.out(1.2)" });
        }

        express(mood) {
            gsap.killTweensOf(this.eyelids);
            gsap.killTweensOf(this.mouth);

            if(mood === 'angry') {
                gsap.to(this.eyelids, { height: '55%', duration: 0.2 });
                gsap.to(this.mouth, { width: 10, borderRadius: 0, height: 2, duration: 0.2 });
            } else if (mood === 'shock') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.1 });
                gsap.to(this.mouth, { width: 12, height: 12, borderRadius: '50%', duration: 0.1 });
            } else if (mood === 'suspicious') {
                gsap.to(this.eyelids, { height: '35%', duration: 0.4 });
                gsap.to(this.mouth, { x: 3, width: 8, duration: 0.4 });
            } else if (mood === 'happy') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.3 });
                gsap.to(this.mouth, { borderRadius: '0 0 20px 20px', height: 8, width: 18, duration: 0.3 });
            } else { // Neutral
                gsap.to(this.eyelids, { height: '0%', duration: 0.5 });
                const w = this.id === 'yellow' ? 15 : (this.id === 'orange' ? 25 : 15);
                gsap.to(this.mouth, { width: w, height: 4, borderRadius: '5px', x: 0, duration: 0.5 });
            }
        }

        // --- GESTOS SOCIALES ---
        nod() {
            gsap.to(this.el, { y: 3, duration: 0.15, yoyo: true, repeat: 1 });
        }

        shakeHead() {
            gsap.to(this.face, { x: "+=3", duration: 0.1, yoyo: true, repeat: 3 });
        }

        talk(isWhispering = false) {
            if(this.isTalking) return;
            this.isTalking = true;
            
            if(this.id === 'orange' && this.currentFaceX > 100) {
                // Si está de espaldas, rebota
                this.bodyTalk = gsap.to(this.el, { y: -2, scaleY: 1.01, duration: 0.2, yoyo: true, repeat: -1 });
                return;
            }

            const speed = isWhispering ? 0.1 : 0.15;
            const size = isWhispering ? "+=1" : "+=4";

            this.mouthTalk = gsap.to(this.mouth, { 
                height: size, width: "+=2", 
                duration: speed, repeat: -1, yoyo: true 
            });
        }

        stopTalk() {
            this.isTalking = false;
            if(this.mouthTalk) this.mouthTalk.kill();
            if(this.bodyTalk) this.bodyTalk.kill();
            gsap.to(this.el, { y: 0, scaleY: 1, duration: 0.3 });
            this.express('neutral');
        }

        // --- ACCIONES FX ---
        spit() {
            this.express('angry');
            gsap.to(this.el, { scale: 0.9, y: 5, duration: 0.3, onComplete: () => {
                gsap.to(this.el, { scale: 1.1, y: -5, duration: 0.1, yoyo: true, repeat: 1 });
                const spit = document.createElement('div');
                spit.className = 'spit';
                const rect = this.mouth.getBoundingClientRect();
                spit.style.left = rect.left + 'px'; spit.style.top = rect.top + 'px';
                document.body.appendChild(spit);
                gsap.to(spit, {
                    scale: 6, opacity: 0, top: window.innerHeight/2, left: window.innerWidth/2,
                    duration: 0.5, ease: "power2.in", onComplete: () => spit.remove()
                });
            }});
        }

        shiver() {
            this.express('shock');
            gsap.to(this.el, { x: 2, duration: 0.05, repeat: 10, yoyo: true });
            const sweat = document.createElement('div');
            sweat.className = 'sweat';
            this.el.appendChild(sweat);
            gsap.set(sweat, { left: '100%', top: 0 });
            gsap.to(sweat, { top: 20, opacity: 0, duration: 1, onComplete: () => sweat.remove() });
        }

        breathe() {
            const rate = Math.random() * 1 + 2;
            gsap.to(this.el, { scaleY: 1.015, y: -1, duration: rate, repeat: -1, yoyo: true, ease: "sine.inOut" });
        }

        blink() {
            setTimeout(() => {
                gsap.to(this.eyelids, { height: '100%', duration: 0.1, yoyo: true, repeat: 1 });
                this.blink();
            }, Math.random() * 4000 + 2000);
        }
    }

    // --- DIRECTOR (CEREBRO) ---
    const Director = {
        chars: {},
        state: 'IDLE', 
        annoyance: 0,
        timer: null,

        init() {
            const stage = document.getElementById('stage');
            CHARS_CONFIG.forEach(c => this.chars[c.id] = new Character(c, stage));

            document.body.addEventListener('pointerdown', (e) => {
                if(!e.target.closest('.char-wrapper')) this.handleGlobalTouch();
            });
            document.addEventListener('contextmenu', e => e.preventDefault());

            this.brainLoop();
        },

        // --- MAQUINA DE ESTADOS SOCIALES ---
        brainLoop() {
            if (this.state === 'ANGRY') return;

            // Resetear estado físico (dejar de hablar, volver a eje vertical)
            Object.values(this.chars).forEach(c => {
                c.stopTalk();
                c.lean(0); // Volver a estar rectos
            });

            const scenario = Math.random();

            if (scenario < 0.4) {
                this.scenario_GossipNormal();
            } else if (scenario < 0.7) {
                this.scenario_SecretHuddle();
            } else if (scenario < 0.9) {
                this.scenario_ParanoidCheck();
            } else {
                this.scenario_Disagreement();
            }

            // Siguiente ciclo
            this.timer = setTimeout(() => this.brainLoop(), Math.random() * 2500 + 2000);
        },

        // ESCENARIO 1: Chisme Estándar
        scenario_GossipNormal() {
            const ids = Object.keys(this.chars);
            const speaker = this.chars[ids[Math.floor(Math.random() * ids.length)]];
            speaker.talk();

            Object.values(this.chars).forEach(c => {
                if(c !== speaker) {
                    // Gordito no gira, solo escucha
                    if(c.id === 'orange') return;
                    
                    // A veces miran al hablante, a veces miran al vacío
                    if(Math.random() > 0.3) {
                        const dir = (speaker.id === 'purple' || speaker.id === 'black') ? -1 : 1;
                        c.look(dir * 2, 0);
                    }
                    
                    // Asentir ocasionalmente
                    if(Math.random() > 0.7) setTimeout(() => c.nod(), 1000);
                }
            });
        },

        // ESCENARIO 2: El "Huddle" (Secreto)
        scenario_SecretHuddle() {
            // Todos se inclinan hacia el centro
            Object.values(this.chars).forEach(c => {
                c.lean(c.config.leanDir); // Inclinarse
                c.express('suspicious');
                c.talk(true); // Susurrar
                
                // Si es el gordito, acerca un poco la cara al centro
                if(c.id === 'orange') c.turnTo(160, 1); 
                else c.look(0, 0); // Ojos al centro
            });

            // En medio del secreto, uno vigila
            setTimeout(() => {
                if(this.state === 'ANGRY') return;
                const spy = this.chars['purple']; // El lider suele vigilar
                spy.stopTalk();
                spy.lean(0); // Se pone recto
                spy.look(3, 0); // Mira al usuario
                spy.express('suspicious');
                
                setTimeout(() => {
                    if(this.state === 'ANGRY') return;
                    spy.lean(spy.config.leanDir); // Vuelve al grupo
                    spy.talk(true);
                }, 1500);
            }, 1000);
        },

        // ESCENARIO 3: Paranoia (Hablando de TI)
        scenario_ParanoidCheck() {
            // Uno habla
            const speaker = this.chars['black'];
            speaker.talk();

            // Otro (Amarillo) mira fijamente a la cámara con miedo
            const watcher = this.chars['yellow'];
            watcher.express('shock');
            watcher.look(0, 0); // Mirada frontal
            watcher.shiver();

            // El lider mira al amarillo como diciendo "¿Qué haces?"
            const leader = this.chars['purple'];
            leader.look(4, 0); // Mira al amarillo
            leader.express('angry');
        },

        // ESCENARIO 4: Desacuerdo
        scenario_Disagreement() {
            const speaker = this.chars['purple'];
            speaker.talk();
            speaker.express('angry');

            setTimeout(() => {
                // El negro niega con la cabeza
                this.chars['black'].shakeHead();
                this.chars['black'].express('bored');
                
                // El amarillo mira al negro preocupado
                this.chars['yellow'].look(-3, 0);
            }, 500);
        },

        // --- INTERACCIONES ---
        handleGlobalTouch() {
            this.annoyance++;
            clearTimeout(this.timer);
            Object.values(this.chars).forEach(c => { c.stopTalk(); c.lean(0); });

            // NIVEL 1: ALERTA (Se callan y miran)
            if (this.annoyance <= 3) {
                this.state = 'SUSPICIOUS';
                
                // Gordito: Mira por encima del hombro
                const fat = this.chars['orange'];
                fat.turnTo(70, 0.8); fat.look(4, 0); fat.express('suspicious');

                // Lider: Te juzga
                const purple = this.chars['purple'];
                purple.express('suspicious'); purple.look(3, 0);
                
                // Los otros cruzan miradas entre ellos
                this.chars['yellow'].look(-3, 0); // Mira al negro
                this.chars['black'].look(3, 0);   // Mira al amarillo

                setTimeout(() => this.recover(), 2500);
            } 
            // NIVEL 2: CONFRONTACIÓN
            else {
                this.state = 'ANGRY';
                
                // Gordito se gira completo
                this.chars['orange'].turnTo(0, 1.5); this.chars['orange'].express('angry');
                
                // Resto encara
                this.chars['purple'].turnTo(0, 0.5); this.chars['purple'].express('angry');
                this.chars['yellow'].turnTo(0, 0.3); this.chars['yellow'].shiver();
                this.chars['black'].express('angry');

                // SPAM CHECK
                if (this.annoyance > 7) {
                    this.chars['black'].spit();
                    this.annoyance = 0;
                }
                setTimeout(() => this.recover(), 4000);
            }
        },

        handleCharTouch(char) {
            this.annoyance = 5;
            clearTimeout(this.timer);
            Object.values(this.chars).forEach(c => { c.stopTalk(); c.lean(0); });

            gsap.to(char.el, { scale: 1.15, duration: 0.1, yoyo: true, repeat: 1 });

            if(char.id === 'orange') { // Susto por la espalda
                char.turnTo(0, 0.2); char.express('shock');
                setTimeout(() => char.turnTo(200, 1.5), 2000);
            } else if (char.id === 'black') {
                char.spit();
            } else if (char.id === 'yellow') {
                char.shiver();
            }

            // El resto mira al tocado
            Object.values(this.chars).forEach(c => {
                if(c !== char) {
                    c.turnTo(0, 0.5);
                    c.look(char.id === 'orange' ? -3 : 3, 0);
                    c.express('shock');
                }
            });
            setTimeout(() => this.recover(), 3000);
        },

        recover() {
            this.state = 'IDLE';
            this.annoyance = Math.max(0, this.annoyance - 2);
            Object.values(this.chars).forEach(c => {
                c.turnTo(c.config.faceX, 1.2, Math.random()*0.5);
                c.express('neutral');
                c.look(0, 0);
            });
            this.timer = setTimeout(() => this.brainLoop(), 2000);
        }
    };

    window.onload = () => Director.init();

</script>
</body>
</html>
