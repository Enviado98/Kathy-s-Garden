<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Gang - No Zoom</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        /* --- CORE SETUP ANTI-ZOOM & FLUIDITY --- */
        :root {
            --bg: #f0f0f5;
            --c-purple: #7b2cbf;
            --c-black: #212529;
            --c-yellow: #ffd60a;
            --c-orange: #ff9f1c;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Vital */
            background-color: var(--bg);
            font-family: sans-serif;
            touch-action: none; /* Deshabilita gestos del navegador */
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ESCENARIO */
        .stage {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            pointer-events: none; /* Click through to chars */
        }

        /* --- BASE CHARACTERS --- */
        .char-wrapper {
            position: absolute;
            bottom: 20px;
            pointer-events: auto; /* Enable touch */
            will-change: transform;
        }

        .body-shape {
            position: relative;
            overflow: hidden; /* La cara se mueve DENTRO de esto */
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Contenedor de rasgos faciales que se desliza */
        .face-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .eyes-row {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: space-evenly;
            /* Top se define por JS/CSS específico */
        }

        .eye {
            position: relative;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .pupil {
            position: absolute;
            background: black;
            border-radius: 50%;
            width: 40%;
            height: 40%;
        }

        .eyelid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0%; /* 0 = abierto, 100 = cerrado */
            background: inherit; /* Toma el color del cuerpo */
            z-index: 10;
        }
        /* Color específico para párpados porque 'inherit' a veces falla con nesting complejo */
        .char-purple .eyelid { background: var(--c-purple); }
        .char-black .eyelid { background: var(--c-black); }
        .char-yellow .eyelid { background: var(--c-yellow); }
        .char-orange .eyelid { background: var(--c-orange); }

        .mouth {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            border-radius: 10px;
        }

        /* --- ESTILOS INDIVIDUALES --- */

        /* 1. LIDER (Morado) - Rectángulo alto */
        .char-purple .body-shape {
            width: 110px;
            height: 220px;
            background: var(--c-purple);
            border-radius: 15px;
        }
        .char-purple .eyes-row { top: 60px; padding: 0 10px; box-sizing: border-box;}
        .char-purple .eye { width: 24px; height: 24px; }
        .char-purple .mouth { top: 100px; width: 20px; height: 4px; }

        /* 2. ODIO/ABURRIDO (Negro) - Cuadrado */
        .char-black .body-shape {
            width: 90px;
            height: 160px;
            background: var(--c-black);
            border-radius: 8px;
        }
        .char-black .eyes-row { top: 50px; padding: 0 5px; box-sizing: border-box; }
        .char-black .eye { width: 20px; height: 20px; background: white; }
        .char-black .mouth { top: 85px; width: 15px; height: 2px; background: #eee; }

        /* 3. NERVIOSO (Amarillo) - Pastilla */
        .char-yellow .body-shape {
            width: 80px;
            height: 130px;
            background: var(--c-yellow);
            border-radius: 40px 40px 0 0;
        }
        .char-yellow .eyes-row { top: 40px; }
        .char-yellow .eye { width: 14px; height: 14px; }
        .char-yellow .mouth { top: 65px; width: 8px; height: 8px; border-radius: 50%; }

        /* 4. TONTO (Naranja) - Gota gorda */
        .char-orange .body-shape {
            width: 140px;
            height: 110px;
            background: var(--c-orange);
            border-radius: 60px 60px 10px 10px;
        }
        .char-orange .eyes-row { top: 35px; width: 60%; left: 20%; position: absolute; }
        .char-orange .eye { width: 12px; height: 12px; }
        .char-orange .mouth { top: 60px; width: 30px; height: 10px; border-radius: 0 0 30px 30px; }

        /* Helpers de debug o efectos */
        .debug-touch {
            position: absolute;
            width: 20px; height: 20px; background: red; border-radius: 50%;
            pointer-events: none; opacity: 0;
        }

    </style>
</head>
<body>

    <div class="stage" id="stage"></div>

<script>
    // --- 1. PREVENCIÓN DE ZOOM (Nivel Dios) ---
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });
    
    // --- 2. CLASE PERSONAJE (CEREBRO INDIVIDUAL) ---
    class Character {
        constructor(config, stage) {
            this.config = config;
            this.stage = stage;
            this.isTalking = false;
            this.mood = 'neutral';
            
            // Render
            this.el = this.createDOM();
            this.body = this.el.querySelector('.body-shape');
            this.face = this.el.querySelector('.face-container');
            this.eyes = this.el.querySelectorAll('.eye');
            this.pupils = this.el.querySelectorAll('.pupil');
            this.eyelids = this.el.querySelectorAll('.eyelid');
            this.mouth = this.el.querySelector('.mouth');

            // Estado de animación
            this.breathingAnim = null;
            this.talkingAnim = null;
            
            // Iniciar vida
            this.breathe();
            this.blinkLoop();
        }

        createDOM() {
            const wrapper = document.createElement('div');
            wrapper.className = `char-wrapper char-${this.config.id}`;
            wrapper.style.left = this.config.x + '%';
            wrapper.style.zIndex = this.config.z;

            // Inyectar HTML interno
            wrapper.innerHTML = `
                <div class="body-shape">
                    <div class="face-container">
                        <div class="eyes-row">
                            <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                            <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                        </div>
                        <div class="mouth"></div>
                    </div>
                </div>
            `;
            this.stage.appendChild(wrapper);
            return wrapper;
        }

        // --- MOTOR DE EXPRESIÓN ---

        // Mueve la cara (ojos/boca) dentro del cuerpo para simular dirección
        lookAt(x, y, urgency = 1) {
            const rect = this.body.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Calculamos desplazamiento relativo (-1 a 1)
            let dx = (x - centerX) / (window.innerWidth / 2);
            let dy = (y - centerY) / (window.innerHeight / 2);
            
            // Limitamos para que la cara no se salga del cuerpo
            dx = Math.max(-1, Math.min(1, dx));
            dy = Math.max(-1, Math.min(1, dy));

            // Mover el contenedor de la cara (Parallax Effect)
            // Cada personaje tiene un límite de movimiento facial definido en config
            const rangeX = this.config.faceRangeX || 15;
            const rangeY = this.config.faceRangeY || 5;

            gsap.to(this.face, {
                x: dx * rangeX,
                y: dy * rangeY,
                duration: 0.5 / urgency,
                ease: "power2.out"
            });

            // Mover pupilas (Detalle extra)
            const pupilRange = 4;
            gsap.to(this.pupils, {
                x: dx * pupilRange,
                y: dy * pupilRange,
                duration: 0.2 / urgency
            });
        }

        setExpression(type) {
            this.mood = type;
            // Resetear
            gsap.killTweensOf(this.eyelids);
            gsap.killTweensOf(this.mouth);

            if(type === 'angry') {
                gsap.to(this.eyelids, { height: '55%', duration: 0.3 }); // Ojos entrecerrados
                gsap.to(this.mouth, { width: 10, height: 2, borderRadius: 0, duration: 0.3 }); // Boca línea
            } else if(type === 'surprise') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.1 });
                gsap.to(this.mouth, { width: 15, height: 15, borderRadius: '50%', duration: 0.2 }); // Boca O
            } else if(type === 'bored') {
                gsap.to(this.eyelids, { height: '40%', duration: 0.5 });
                gsap.to(this.mouth, { width: 12, height: 2, duration: 0.5 });
            } else if(type === 'suspicious') {
                gsap.to(this.eyelids, { height: '30%', duration: 0.4 });
                gsap.to(this.mouth, { x: 5, width: 8, duration: 0.4 }); // Boca torcida
            } else {
                // Neutral
                gsap.to(this.eyelids, { height: '0%', duration: 0.4 });
                gsap.to(this.mouth, { width: 18, height: 5, borderRadius: '0 0 20px 20px', x: 0, duration: 0.4 });
            }
        }

        startTalking() {
            if(this.isTalking) return;
            this.isTalking = true;
            this.talkingAnim = gsap.to(this.mouth, {
                height: () => Math.random() * 8 + 2,
                width: () => Math.random() * 5 + 10,
                duration: 0.15,
                repeat: -1,
                yoyo: true
            });
        }

        stopTalking() {
            this.isTalking = false;
            if(this.talkingAnim) this.talkingAnim.kill();
            this.setExpression(this.mood); // Restaurar boca según estado
        }

        // --- VIDA INTERNA ---
        breathe() {
            // Respiración única basada en su personalidad
            const speed = this.config.breathSpeed || 2;
            this.breathingAnim = gsap.to(this.body, {
                scaleY: 1.02,
                scaleX: 0.99,
                y: -2,
                duration: speed,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut",
                delay: Math.random()
            });
        }

        blinkLoop() {
            if(this.mood === 'angry') {
                setTimeout(() => this.blinkLoop(), 1000);
                return; 
            }
            
            const tl = gsap.timeline({
                onComplete: () => {
                    const nextBlink = Math.random() * 3000 + 1000;
                    setTimeout(() => this.blinkLoop(), nextBlink);
                }
            });
            tl.to(this.eyelids, { height: '100%', duration: 0.1 })
              .to(this.eyelids, { height: '0%', duration: 0.15 });
        }
    }

    // --- 3. DIRECTOR DE ESCENA (IA GLOBAL) ---
    class Director {
        constructor() {
            this.stage = document.getElementById('stage');
            this.chars = {};
            this.state = 'IDLE'; // IDLE, GOSSIP, JUDGING
            this.interruptionTimer = null;

            // Configuración de Personalidades
            const configs = [
                { id: 'purple', x: 15, z: 10, faceRangeX: 20, breathSpeed: 2.5 }, // Líder
                { id: 'black', x: 38, z: 5, faceRangeX: 10, breathSpeed: 3 }, // Aburrido
                { id: 'yellow', x: 60, z: 8, faceRangeX: 18, breathSpeed: 0.8 }, // Nervioso (respira rápido)
                { id: 'orange', x: 80, z: 12, faceRangeX: 25, breathSpeed: 2.2 } // Tonto (gran rango movimiento)
            ];

            configs.forEach(c => {
                this.chars[c.id] = new Character(c, this.stage);
            });

            this.charArray = Object.values(this.chars);
            
            this.initInteractions();
            this.startBrain();
        }

        // --- LÓGICA DE INTERACCIÓN ---
        initInteractions() {
            // TOQUE EN PANTALLA
            const handleInput = (e) => {
                if(this.state === 'JUDGING') return; // Ya están enojados
                this.triggerJudgment();
            };
            
            document.body.addEventListener('pointerdown', handleInput);
        }

        // --- CEREBRO PRINCIPAL ---
        startBrain() {
            const think = () => {
                if(this.state === 'JUDGING') return; // Cerebro congelado por ira

                const r = Math.random();

                if (this.state === 'IDLE') {
                    if (r < 0.3) this.startGossip(); // 30% empezar chisme
                    else this.lookAroundRandomly();
                } else if (this.state === 'GOSSIP') {
                    if (r < 0.2) this.changeSpeaker();
                    else if (r < 0.4) this.suspiciousCheck(); // MIRADA DE SOSPECHA
                    else if (r > 0.8) this.stopGossip(); // Silencio incómodo
                }

                // Siguiente pensamiento
                setTimeout(think, Math.random() * 2000 + 1500);
            };
            think();
        }

        // --- COMPORTAMIENTOS ---

        lookAroundRandomly() {
            this.charArray.forEach(c => {
                // Miran a la nada
                c.lookAt(
                    window.innerWidth/2 + (Math.random()-0.5)*500,
                    window.innerHeight/2 + (Math.random()-0.5)*300
                );
                c.setExpression('neutral');
            });
        }

        startGossip() {
            this.state = 'GOSSIP';
            this.changeSpeaker();
        }

        changeSpeaker() {
            // Resetear anteriores
            this.charArray.forEach(c => c.stopTalking());

            // Elegir hablante
            const speaker = this.getRandomChar();
            speaker.startTalking();
            speaker.setExpression('neutral');

            // El hablante mira "al grupo" (centro aproximado) o al frente con confianza
            speaker.lookAt(window.innerWidth/2, window.innerHeight/2 + 100);

            // Los demás miran al hablante
            const speakerRect = speaker.body.getBoundingClientRect();
            const targetX = speakerRect.left + speakerRect.width/2;
            const targetY = speakerRect.top + 30; // Miran a los ojos del hablante

            this.charArray.forEach(c => {
                if(c !== speaker) {
                    // Reacciones variadas
                    if(c.config.id === 'black') c.setExpression('bored'); // Negro siempre aburrido
                    else if(c.config.id === 'yellow') c.setExpression('surprise'); // Amarillo impresionado
                    else c.setExpression('neutral');

                    c.lookAt(targetX, targetY);
                }
            });
        }

        suspiciousCheck() {
            // "Uno mira de reojo a la pantalla"
            const paranoid = this.getRandomChar();
            
            // Guarda posición actual para volver
            const prevMood = paranoid.mood;
            
            // Mira rápido al usuario
            paranoid.lookAt(window.innerWidth/2, window.innerHeight/2, 2); // 2 = más urgente
            paranoid.setExpression('suspicious');

            // Vuelve a mirar al grupo después de 800ms
            setTimeout(() => {
                if(this.state === 'JUDGING') return;
                // Si estaba hablando, sigue hablando
                paranoid.setExpression(prevMood);
                // Volver a mirar al hablante actual (simplificado: mira al centro)
                paranoid.lookAt(window.innerWidth/2, window.innerHeight/2 + 100); 
            }, 800);
        }

        stopGossip() {
            this.state = 'IDLE';
            this.charArray.forEach(c => c.stopTalking());
            this.lookAroundRandomly();
        }

        // --- LA REACCIÓN DE "NO ME TOQUES" ---
        triggerJudgment() {
            console.log("JUDGMENT DAY");
            this.state = 'JUDGING';
            
            // Detener charla
            this.charArray.forEach(c => c.stopTalking());

            // CALCULAR EL CENTRO DE LA PANTALLA (USUARIO)
            const userX = window.innerWidth / 2;
            const userY = window.innerHeight / 2;

            // REACCIÓN ESCALONADA (Staggered)
            // Cada uno tiene un tiempo de reacción diferente según personalidad
            const reactionTimes = {
                'yellow': 0.1, // Nervioso: Inmediato
                'purple': 0.3, // Líder: Controlado
                'black': 0.5,  // Aburrido: Lento
                'orange': 0.8  // Tonto: Muy lento
            };

            this.charArray.forEach(c => {
                const delay = reactionTimes[c.config.id];

                // 1. Congelar un momento
                setTimeout(() => {
                    // 2. Mover la CARA (ojos y boca) hacia el usuario lentamente
                    c.lookAt(userX, userY, 0.5); // 0.5 = lento y dramático
                    
                    // 3. Cambiar expresión a Enojado
                    c.setExpression('angry');

                    // 4. Pequeño salto de indignación (Cuerpo)
                    gsap.to(c.body, { y: -10, duration: 0.2, yoyo: true, repeat: 1 });

                }, delay * 1000);
            });

            // RELAJARSE DESPUÉS DE UN RATO
            clearTimeout(this.interruptionTimer);
            this.interruptionTimer = setTimeout(() => {
                this.recover();
            }, 4000); // 4 segundos de juicio silencioso
        }

        recover() {
            this.state = 'IDLE';
            // Uno suspira y vuelven a lo suyo
            this.charArray.forEach(c => {
                c.setExpression('neutral');
            });
            this.startGossip();
        }

        getRandomChar() {
            return this.charArray[Math.floor(Math.random() * this.charArray.length)];
        }
    }

    // ARRANQUE
    window.onload = () => new Director();

</script>
</body>
</html>
