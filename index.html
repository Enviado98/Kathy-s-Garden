<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gossip Gang: Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg: #e8e8f2;
            --purple: #6a1b9a;
            --black: #212121;
            --orange: #ff6f00; /* Naranja fuerte */
            --yellow: #fdd835;
        }

        /* --- 1. CORE & NO-SELECT (Fix del Azul) --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0); /* CLAVE: Quita el azul */
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            touch-action: none; /* Bloqueo gestos nativos */
        }

        /* --- ESCENARIO --- */
        .stage {
            position: relative;
            width: 340px;
            height: 320px;
            pointer-events: none; /* Dejamos pasar clicks a los bichos */
        }

        /* --- ESTRUCTURA DE PERSONAJE --- */
        .char-wrapper {
            position: absolute;
            bottom: 0;
            pointer-events: auto; /* Reactivar clicks */
            overflow: hidden; /* Mantiene la cara dentro del cuerpo */
            transform-origin: bottom center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: transform 0.1s;
            will-change: transform;
        }

        /* Contenedor deslizante de la cara (Parallax) */
        .face-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        .eyes-row {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }

        .eye {
            position: relative;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .pupil {
            position: absolute;
            background: black;
            border-radius: 50%;
            width: 45%; height: 45%;
            top: 27%; left: 27%;
        }

        .eyelid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 0%;
            background: inherit; 
            z-index: 10;
        }
        /* Fix Safari Colors */
        .c-purple .eyelid { background: var(--purple); }
        .c-black .eyelid { background: var(--black); }
        .c-orange .eyelid { background: var(--orange); }
        .c-yellow .eyelid { background: var(--yellow); }

        .mouth {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            border-radius: 10px;
        }

        /* --- DISEÑOS INDIVIDUALES --- */

        /* MORADO (Líder) */
        #purple {
            left: 30px; bottom: 90px;
            width: 90px; height: 200px;
            background: var(--purple);
            border-radius: 8px;
            z-index: 10;
        }
        #purple .eyes-row { top: 60px; padding: 0 10px; }
        #purple .eye { width: 20px; height: 20px; }
        #purple .mouth { top: 95px; width: 20px; height: 4px; }

        /* NEGRO (Hater) */
        #black {
            left: 140px; bottom: 80px;
            width: 80px; height: 160px;
            background: var(--black);
            border-radius: 6px;
            z-index: 5;
        }
        #black .eyes-row { top: 50px; padding: 0 8px; }
        #black .eye { width: 16px; height: 16px; }
        #black .mouth { top: 80px; width: 12px; height: 2px; background: #666; }

        /* AMARILLO (Nervioso) */
        #yellow {
            right: 20px; bottom: 0;
            width: 80px; height: 130px;
            background: var(--yellow);
            border-radius: 40px 40px 0 0;
            z-index: 20;
        }
        #yellow .eyes-row { top: 40px; padding: 0 10px; }
        #yellow .eye { width: 12px; height: 12px; background: #111; }
        #yellow .pupil { display: none; }
        #yellow .mouth { top: 65px; width: 15px; height: 3px; }

        /* NARANJA (Gordito - De Espaldas) */
        #orange {
            left: -10px; bottom: 0;
            width: 190px; height: 110px;
            background: var(--orange);
            border-radius: 95px 95px 10px 10px;
            z-index: 30; /* Al frente */
        }
        #orange .eyes-row { top: 35px; justify-content: center; gap: 20px; }
        #orange .eye { width: 15px; height: 15px; }
        #orange .mouth { top: 65px; width: 25px; height: 5px; }

        /* --- PARTÍCULAS --- */
        .spit {
            position: fixed;
            width: 12px; height: 12px;
            background: #a0e0ff;
            border-radius: 50%;
            border: 2px solid #fff;
            pointer-events: none;
            z-index: 9999;
        }
        .sweat {
            position: absolute;
            width: 8px; height: 12px;
            background: #00d2ff;
            border-radius: 0 50% 50% 50%;
            transform: rotate(45deg);
        }

    </style>
</head>
<body>

<div class="stage" id="stage"></div>

<script>
    /**
     * MOTOR DE COMPORTAMIENTO "LIVING TOYS"
     */

    // Configuración Inicial
    // faceX: Posición inicial de la cara (0=centro, >100=oculta/espalda)
    const CHARS_CONFIG = [
        { id: 'purple', type: 'rect', faceX: 30,  role: 'leader' },
        { id: 'black',  type: 'rect', faceX: 0,   role: 'hater' },
        { id: 'yellow', type: 'round', faceX: -20, role: 'nervous' },
        { id: 'orange', type: 'fat',   faceX: 200, role: 'fat' } // 200 = Totalmente de espaldas
    ];

    class Character {
        constructor(config, stage) {
            this.id = config.id;
            this.config = config;
            this.role = config.role;
            this.currentFaceX = config.faceX;
            this.isTalking = false;

            this.el = this.createDOM(stage);
            this.face = this.el.querySelector('.face-layer');
            this.pupils = this.el.querySelectorAll('.pupil');
            this.eyelids = this.el.querySelectorAll('.eyelid');
            this.mouth = this.el.querySelector('.mouth');

            // Set inicial
            gsap.set(this.face, { x: this.currentFaceX });
            
            // Ciclos de vida
            this.breathe();
            this.blink();

            // Interacción Individual
            this.el.addEventListener('pointerdown', (e) => {
                e.stopPropagation(); // Evita tocar el fondo
                e.preventDefault(); // Evita selección
                Director.handleCharTouch(this);
            });
        }

        createDOM(stage) {
            const div = document.createElement('div');
            div.className = `char-wrapper c-${this.id}`;
            div.id = this.id;
            div.innerHTML = `
                <div class="face-layer">
                    <div class="eyes-row">
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                        <div class="eye"><div class="pupil"></div><div class="eyelid"></div></div>
                    </div>
                    <div class="mouth"></div>
                </div>
            `;
            stage.appendChild(div);
            return div;
        }

        // --- SISTEMA DE MOVIMIENTO ---

        // Mueve la cara entera (Giro de cabeza/cuerpo)
        turnTo(targetX, speed = 1, delay = 0) {
            this.currentFaceX = targetX;
            gsap.to(this.face, {
                x: targetX,
                duration: speed,
                delay: delay,
                ease: "power2.inOut"
            });
        }

        // Mueve solo las pupilas (Mirada)
        look(x, y) {
            // El amarillo no tiene pupilas
            if(this.id !== 'yellow') {
                gsap.to(this.pupils, { x: x, y: y, duration: 0.3 });
            }
        }

        express(mood) {
            gsap.killTweensOf(this.eyelids);
            gsap.killTweensOf(this.mouth);

            if(mood === 'angry') {
                gsap.to(this.eyelids, { height: '55%', duration: 0.2 });
                gsap.to(this.mouth, { width: 10, borderRadius: 0, height: 2, duration: 0.2 });
            } else if (mood === 'shock') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.1 });
                gsap.to(this.mouth, { width: 12, height: 12, borderRadius: '50%', duration: 0.1 });
            } else if (mood === 'suspicious') {
                gsap.to(this.eyelids, { height: '35%', duration: 0.4 });
                gsap.to(this.mouth, { x: 3, width: 8, duration: 0.4 });
            } else if (mood === 'happy') {
                gsap.to(this.eyelids, { height: '0%', duration: 0.3 });
                gsap.to(this.mouth, { borderRadius: '0 0 20px 20px', height: 8, width: 18, duration: 0.3 });
            } else {
                // Neutral
                gsap.to(this.eyelids, { height: '0%', duration: 0.5 });
                const w = this.id === 'yellow' ? 15 : (this.id === 'orange' ? 25 : 15);
                gsap.to(this.mouth, { width: w, height: 4, borderRadius: '5px', x: 0, duration: 0.5 });
            }
        }

        talk() {
            if(this.isTalking) return;
            this.isTalking = true;
            
            // Si está de espaldas (Gordito), no mueve la boca, mueve el cuerpo
            if(this.id === 'orange' && this.currentFaceX > 100) {
                this.bodyTalk = gsap.to(this.el, { y: -3, scaleY: 1.02, duration: 0.2, yoyo: true, repeat: -1 });
                return;
            }

            this.mouthTalk = gsap.to(this.mouth, { 
                height: "+=4", width: "+=2", 
                duration: 0.15, repeat: -1, yoyo: true 
            });
        }

        stopTalk() {
            this.isTalking = false;
            if(this.mouthTalk) this.mouthTalk.kill();
            if(this.bodyTalk) this.bodyTalk.kill();
            gsap.to(this.el, { y: 0, scaleY: 1, duration: 0.3 });
            this.express('neutral');
        }

        // --- ACCIONES ESPECIALES ---
        
        spit() {
            // Acción exclusiva del Negro
            this.express('angry');
            // Cargar hacia atrás
            gsap.to(this.el, { scale: 0.9, y: 5, duration: 0.3, onComplete: () => {
                // Disparar hacia adelante
                gsap.to(this.el, { scale: 1.1, y: -5, duration: 0.1, yoyo: true, repeat: 1 });
                
                // Crear partícula
                const spit = document.createElement('div');
                spit.className = 'spit';
                const rect = this.mouth.getBoundingClientRect();
                spit.style.left = rect.left + 'px';
                spit.style.top = rect.top + 'px';
                document.body.appendChild(spit);

                // Volar hacia la cámara
                gsap.to(spit, {
                    scale: 5,
                    opacity: 0,
                    top: window.innerHeight / 2,
                    left: window.innerWidth / 2,
                    duration: 0.5,
                    ease: "power2.in",
                    onComplete: () => spit.remove()
                });
            }});
        }

        shiver() {
            // Acción exclusiva del Amarillo
            this.express('shock');
            gsap.to(this.el, { x: 2, duration: 0.05, repeat: 10, yoyo: true });
            
            // Gotita de sudor
            const sweat = document.createElement('div');
            sweat.className = 'sweat';
            this.el.appendChild(sweat);
            gsap.set(sweat, { left: '100%', top: 0 });
            gsap.to(sweat, { top: 20, opacity: 0, duration: 1, onComplete: () => sweat.remove() });
        }

        laugh() {
            // El gordito se ríe
            this.express('happy');
            gsap.to(this.el, { scaleX: 1.05, scaleY: 0.95, duration: 0.2, repeat: 3, yoyo: true });
        }

        // --- VIDA AUTÓNOMA ---
        breathe() {
            const rate = Math.random() * 1 + 2;
            gsap.to(this.el, { 
                scaleY: 1.015, y: -1, 
                duration: rate, repeat: -1, yoyo: true, ease: "sine.inOut" 
            });
        }

        blink() {
            const next = Math.random() * 4000 + 2000;
            setTimeout(() => {
                // No parpadear si está furioso
                gsap.to(this.eyelids, { height: '100%', duration: 0.1, yoyo: true, repeat: 1 });
                this.blink();
            }, next);
        }
    }

    // --- EL CEREBRO (DIRECTOR) ---
    const Director = {
        chars: {},
        state: 'GOSSIP', // GOSSIP, SUSPICIOUS, ANGRY
        annoyance: 0,
        timer: null,

        init() {
            const stage = document.getElementById('stage');
            CHARS_CONFIG.forEach(c => {
                this.chars[c.id] = new Character(c, stage);
            });

            // ESCUCHADOR GLOBAL DE TOQUES (FONDO)
            document.body.addEventListener('pointerdown', (e) => {
                // Si el target no es un personaje, es el fondo
                if(!e.target.closest('.char-wrapper')) {
                    this.handleGlobalTouch();
                }
            });

            // Evitar menú contextual
            document.addEventListener('contextmenu', event => event.preventDefault());

            this.brainLoop();
        },

        // --- BUCLE PRINCIPAL DE IA ---
        brainLoop() {
            if (this.state === 'ANGRY') return; // Si están enojados, no piensan, solo juzgan.

            // Resetear
            Object.values(this.chars).forEach(c => c.stopTalk());

            // Decidir qué hacer (Random Event Generator)
            const r = Math.random();

            if (r < 0.6) {
                // --- CHISME NORMAL ---
                const speakerId = Object.keys(this.chars)[Math.floor(Math.random() * 4)];
                const speaker = this.chars[speakerId];
                speaker.talk();

                // Reacción de los oyentes
                Object.values(this.chars).forEach(c => {
                    if(c !== speaker) {
                        // Gordito escucha de espaldas (sin girar)
                        if(c.id === 'orange' && Math.random() > 0.5) return; 
                        
                        // Los demás miran sutilmente
                        if(Math.random() > 0.3) {
                             // Pequeño movimiento de ojos hacia quien habla
                             const dir = (speakerId === 'purple') ? -1 : 1;
                             c.look(dir * 2, 0);
                        }
                    }
                });

            } else if (r < 0.8) {
                // --- EVENTO ALEATORIO ---
                const eventR = Math.random();
                if(eventR < 0.3) this.chars['orange'].laugh();
                else if(eventR < 0.6) this.chars['yellow'].shiver();
                else {
                    // El negro se aburre
                    this.chars['black'].express('suspicious');
                    this.chars['black'].turnTo(30, 1); // Mira a otro lado
                    setTimeout(() => this.chars['black'].turnTo(0, 1), 1500);
                }
            }
            
            // Loop siguiente
            this.timer = setTimeout(() => this.brainLoop(), Math.random() * 2000 + 1500);
        },

        // --- INTERACCIÓN: MOLESTAR AL GRUPO (FONDO) ---
        handleGlobalTouch() {
            this.annoyance++;
            clearTimeout(this.timer);
            Object.values(this.chars).forEach(c => c.stopTalk());

            console.log("Annoyance Lvl:", this.annoyance);

            // NIVEL 1: SOSPECHA (1-3 toques)
            if (this.annoyance <= 3) {
                this.state = 'SUSPICIOUS';
                
                // 1. EL GORDITO MIRA POR ENCIMA DEL HOMBRO
                // Su cara está en 200. La traemos a 70 (borde visible)
                const fat = this.chars['orange'];
                fat.turnTo(70, 0.8); 
                fat.look(4, 0); // Ojos al extremo
                fat.express('suspicious');

                // 2. EL LIDER VIGILA
                const purple = this.chars['purple'];
                purple.express('suspicious');
                purple.look(3, 0);

                setTimeout(() => this.recover(), 2500);
            }
            
            // NIVEL 2: ENOJO / CONFRONTACIÓN (4+ toques)
            else {
                this.state = 'ANGRY';

                // TODOS SE GIRAN A MIRARTE
                
                // Gordito se da la vuelta completa (Lento y dramático)
                const fat = this.chars['orange'];
                fat.turnTo(0, 1.5, 0); 
                fat.express('angry');

                // Los demás encaran rápido
                this.chars['purple'].turnTo(0, 0.5);
                this.chars['purple'].express('angry');

                this.chars['yellow'].turnTo(0, 0.3);
                this.chars['yellow'].shiver(); // Se asusta de la tensión

                this.chars['black'].express('angry');
                
                // Si molestas DEMASIADO (spam click > 8)
                if (this.annoyance > 8) {
                    this.chars['black'].spit();
                    this.annoyance = 0; // Resetear tras ataque
                }

                setTimeout(() => this.recover(), 4000);
            }
        },

        // --- INTERACCIÓN: TOCAR A UN BICHO ---
        handleCharTouch(char) {
            this.annoyance = 5; // Escala inmediata
            clearTimeout(this.timer);
            Object.values(this.chars).forEach(c => c.stopTalk());

            // Reacción Individual
            gsap.to(char.el, { scale: 1.15, duration: 0.1, yoyo: true, repeat: 1 });

            if(char.id === 'orange') {
                // El gordito se asusta al ser tocado por la espalda
                char.turnTo(0, 0.2); // Giro ultra rápido
                char.express('shock');
                setTimeout(() => char.turnTo(200, 1.5), 2000); // Se esconde lento
            } else if (char.id === 'black') {
                // El negro te escupe directo
                char.spit();
            } else if (char.id === 'yellow') {
                char.shiver();
            }

            // Los demás miran al tocado
            Object.values(this.chars).forEach(c => {
                if(c !== char) {
                    c.turnTo(0, 0.5);
                    // Ojos apuntando al centro (donde suelen estar)
                    c.look(char.id === 'orange' ? -3 : 3, 0);
                    c.express('shock');
                }
            });

            setTimeout(() => this.recover(), 3000);
        },

        recover() {
            this.state = 'GOSSIP';
            this.annoyance = Math.max(0, this.annoyance - 2); // Baja enojo poco a poco

            // Volver a posiciones originales
            Object.values(this.chars).forEach(c => {
                const delay = Math.random() * 0.5;
                c.turnTo(c.config.faceX, 1.2, delay);
                c.express('neutral');
                c.look(0, 0);
            });

            this.timer = setTimeout(() => this.brainLoop(), 2000);
        }
    };

    // Inicio
    window.onload = () => Director.init();

</script>
</body>
</html>
